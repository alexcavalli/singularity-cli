#!/usr/bin/env ruby
require 'singularity'
require 'json'

# passes "--help" if no arguments given which will result printing usage
ARGV << '--help' if ARGV.empty?

def print_usage
  puts
  exit
end

  def print_usage
    puts <<END
# Usage:
#    singularity deploy <uri> <file.json> <release>
#       - deploy singularity job
#    singularity delete <uri> <file.json>
#       - delete singularity deploy
#    singularity run <commands>
#       - start new box in singularity and run <commands>
#         (do this from the base project folder of the box you wish to start)
#    singularity runx <commands>
#       - same as "singularity run" without use of /sbin/my_init
#    singularity ssh
#       - start new box in singularity and SSH into it
END
  end

action = ARGV[0]
$file = ARGV[1]

if !File.file?('mesos-deploy.yml') or !File.file?('.mescal.json')
  puts 'Please do this command from a project directory (where both mesos-deploy.yml and .mescal.json exist)'
  return
end

mesosDeployYml = YAML.load_file(File.join(Dir.pwd, 'mesos-deploy.yml'))
$uri = mesosDeployYml['singularity_url']
$request = Request.new
$data = JSON.parse(ERB.new(open($file).read).result($request.get_binding))

case action
  when "delete"
    #print_usage unless ARGV.size == 3
    Singularity::Deleter.new.delete

  when "deploy"
    #print_usage unless ARGV.size == 4
    $release = ARGV[3]
    Singularity::Deployer.new.deploy

  when "run"
    # remove the word "run" from ARGV, pass the remainder to Runner
    ARGV.shift
    Singularity::Runner.new(ARGV).run

  when "runx"
    # this option is to skip the use of /sbin/my_init
    # (some commands won't run correctly when both are used)
    Singularity::Runner.new(ARGV).run

  when "ssh"
    Singularity::Runner.new("ssh").run

  else
    print_usage
end



